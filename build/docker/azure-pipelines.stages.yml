parameters:
  configurations: []
    # - name: string
    #   platforms: [ string ]
    #   dependsOn: string

stages:
  - stage: commit
    displayName: Commit

    jobs:
      - ${{ each configuration in parameters.configurations }}:
        - ${{ each platform in configuration.platforms }}:
          - job: build_${{ replace(configuration.name, '-', '_') }}_${{ platform.name }}_${{ platform.variant }}_${{ platform.version }}
            displayName: Build ${{ configuration.name }} on ${{ platform.name }} ${{ platform.variant }} ${{ platform.version }}
            ${{ if configuration.dependsOn }}:
              dependsOn: build_${{ replace(configuration.dependsOn, '-', '_') }}_${{ platform.name }}_${{ platform.variant }}_${{ platform.version }}

            ${{ if eq(platform.name, 'windows') }}:
              pool:
                name: Default
                demands:
                  - AZP_AGENT_WINDOWS
                  - AZP_AGENT_DOCKER

            ${{ if eq(platform.name, 'linux') }}:
              pool:
                name: Default
                demands:
                  - AZP_AGENT_LINUX
                  - AZP_AGENT_DOCKER

            workspace:
              clean: all

            steps:
              - checkout: self
                submodules: recursive

              - script: |
                  docker --version
                  docker-compose --version

                  docker image ls -a
                  docker container ls -a
                displayName: Initialize Docker

              - ${{ if configuration.dependsOn }}:
                - script: |
                    docker-compose pull --quiet ${{ configuration.dependsOn }}-${{ platform.name }}
                  displayName: Restore

              - script: |
                  docker-compose build ${{ configuration.name }}-${{ platform.name }}
                displayName: Build

              - script: |
                  docker-compose run ${{ configuration.name }}-${{ platform.name }}
                displayName: Test

              - task: Docker@2
                displayName: Login Docker
                inputs:
                  command: login
                  containerRegistry: dockerhub-gusztavvargadr

              - script: |
                  docker-compose push ${{ configuration.name }}-${{ platform.name }}
                displayName: Publish

              - task: Docker@2
                displayName: Logout Docker
                inputs:
                  command: logout
                  containerRegistry: dockerhub-gusztavvargadr
                condition: always()

              - script: |
                  docker-compose down --rmi local --volumes
                displayName: Clean
                condition: always()
