parameters:
  configurations: []
    # - name: name
    #   service: service

stages:
  - stage: commit
    displayName: Commit

    jobs:
      - ${{ each configuration in parameters.configurations }}:
        - job: build_${{ configuration.name }}
          displayName: Build ${{ configuration.displayName }}

          pool:
            vmImage: windows-2019

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

            - script: |
                docker version
                docker-compose version
                docker container ls -a
                docker image ls -a
              displayName: Initialize Docker

            - ${{ each service in configuration.services }}:
              - script: |
                  docker-compose build ${{ service }}
                displayName: Build ${{ service }}

              - script: |
                  docker-compose run ${{ service }}
                displayName: Test ${{ service }}

            - script: |
                docker-compose down --rmi all
              displayName: Clean
              condition: always()
