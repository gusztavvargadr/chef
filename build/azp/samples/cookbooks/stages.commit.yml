parameters:
  configurations:
    []
    # - cookbook: cookbook
    #   driver: driver
    #   suites: [ 'suite1', 'suite2' ]

stages:
  - stage: commit
    displayName: Commit

    jobs:
      - ${{ each configuration in parameters.configurations }}:
          - job: build_${{ configuration.cookbook }}
            displayName: Build ${{ configuration.cookbook }}

            pool:
              vmImage: ubuntu-16.04

            workspace:
              clean: all

            steps:
              - checkout: self
                submodules: recursive

              - script: |
                  docker --version
                  docker-compose --version

                  docker image ls -a
                  docker container ls -a
                displayName: Initialize Docker

              - script: |
                  docker-compose pull --quiet chef-workstation-linux

                  docker-compose run chef-workstation-linux exec cookstyle samples/cookbooks/${{ configuration.cookbook }}
                  docker-compose run chef-workstation-linux exec cookstyle samples/cookbooks/${{ configuration.cookbook }}_test

                  docker-compose run chef-workstation-linux exec rspec samples/cookbooks/${{ configuration.cookbook }}_test
                displayName: Test

              - script: |
                  docker-compose down --rmi all
                displayName: Clean
                condition: always()
