parameters:
  options: []
    # - cookbook: cookbook-name
    #   suite: [ 'suite-name-part-1', 'suite-name-part-2' ]

stages:
  - stage: acceptance
    displayName: Acceptance

    jobs:
      - ${{ each option in parameters.options }}:
        - job: test_${{ option.cookbook }}_${{ join('_', option.suite) }}
          displayName: Test ${{ option.cookbook }} ${{ join('-', option.suite) }}

          pool:
            vmImage: windows-2019

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

            - script: |
                docker version
                docker-compose version
                docker container ls -a
                docker image ls -a

                dir C:\ProgramData\Docker\config /s
                echo { "hosts": ["tcp://0.0.0.0:2375", "npipe://"] } > C:\ProgramData\Docker\config\daemon.json
                dir C:\ProgramData\Docker\config /s

                net stop docker
                net start docker
              displayName: Initialize Docker

            - script: |
                choco install chef-workstation --version 0.17.5 --confirm --no-progress
                call refreshenv.cmd
                chef --version
                chef gem build --force ./lib/test-kitchen/kitchen-docker/kitchen-docker.gemspec
                chef gem install --force ./lib/test-kitchen/kitchen-docker/kitchen-docker-2.10.0.gem
              env:
                CHEF_LICENSE: accept-silent
              displayName: Initialize Chef

            - script: |
                call refreshenv.cmd
                cd samples/cookbooks/${{ option.cookbook }}_test
                kitchen create ${{ join('-', option.suite) }}
              env:
                KITCHEN_YAML: .kitchen.docker.yml
                KITCHEN_PLATFORM_WINDOWS_DOCKER_TAG: ltsc2019
              displayName: Create Kitchen

            - script: |
                call refreshenv.cmd
                cd samples/cookbooks/${{ option.cookbook }}_test
                kitchen test ${{ join('-', option.suite) }}
              env:
                KITCHEN_YAML: .kitchen.docker.yml
                KITCHEN_PLATFORM_WINDOWS_DOCKER_TAG: ltsc2019
              displayName: Test Kitchen

            - script: |
                call refreshenv.cmd
                cd samples/cookbooks/${{ option.cookbook }}_test
                kitchen destroy ${{ join('-', option.suite) }}
              env:
                KITCHEN_YAML: .kitchen.docker.yml
                KITCHEN_PLATFORM_WINDOWS_DOCKER_TAG: ltsc2019
              displayName: Clean Kitchen
              condition: always()
