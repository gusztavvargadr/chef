parameters:
  options: []
    # - cookbook: cookbook-name
    #   suite: [ 'suite-name-part-1', 'suite-name-part-2' ]

stages:
  - stage: acceptance
    displayName: Acceptance

    jobs:
      - ${{ each option in parameters.options }}:
        - job: test_${{ option.cookbook }}_${{ join('_', option.suite) }}
          displayName: Test ${{ option.cookbook }} ${{ join('-', option.suite) }}

          pool:
            vmImage: ubuntu-16.04

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

          # pool:
          #   name: Default
          #   demands:
          #     - AZP_AGENT_CHEF
          #     - AZP_AGENT_VAGRANT

          # workspace:
          #   clean: all

          # steps:
          #   - checkout: self
          #     submodules: recursive

          #   - script: |
          #       chef --version
          #       vagrant version
          #       vagrant plugin list
          #     displayName: Init

            # - script: |
            #     cd samples/cookbooks/${{ option.cookbook }}_test
            #     kitchen create ${{ join('-', option.suite) }} || kitchen create ${{ join('-', option.suite) }}
            #   displayName: Restore

            # - script: |
            #     cd samples/cookbooks/${{ option.cookbook }}_test
            #     kitchen converge ${{ join('-', option.suite) }}
            #   displayName: Test - 1 - Converge

            # - script: |
            #     cd samples/cookbooks/${{ option.cookbook }}_test
            #     kitchen verify ${{ join('-', option.suite) }}
            #   displayName: Test - 1 - Verify

            # - script: |
            #     cd samples/cookbooks/${{ option.cookbook }}_test
            #     kitchen converge ${{ join('-', option.suite) }}
            #   displayName: Test - 2 - Converge

            # - script: |
            #     cd samples/cookbooks/${{ option.cookbook }}_test
            #     kitchen verify ${{ join('-', option.suite) }}
            #   displayName: Test - 2 - Verify

            # - script: |
            #     cd samples/cookbooks/${{ option.cookbook }}_test
            #     kitchen destroy ${{ join('-', option.suite) }} || kitchen destroy ${{ join('-', option.suite) }}
            #   displayName: Clean
            #   condition: always()
