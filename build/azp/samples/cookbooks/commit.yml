parameters:
  options: []
    # - cookbook: cookbook-name

stages:
  - stage: commit
    displayName: Commit

    jobs:
      - ${{ each option in parameters.options }}:
        - job: build_${{ option.cookbook }}
          displayName: Build ${{ option.cookbook }}

          pool:
            vmImage: ubuntu-16.04

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

            - script: |
                docker version
                docker-compose version
                docker container ls -a
                docker image ls -a
              displayName: Initialize Docker

            - script: |
                docker-compose pull --quiet chef-workstation-linux
              displayName: Restore Docker

            - script: |
                docker-compose run chef-workstation-linux exec rspec samples/cookbooks/${{ option.cookbook }}_test
              displayName: Run Docker

            - script: |
                docker-compose down --rmi all
              displayName: Clean Docker
              condition: always()
