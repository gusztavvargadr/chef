parameters:
  configurations: []
  # - name: string
  #   policies: [ string ]

stages:
  - stage: commit
    displayName: Commit

    jobs:
      - ${{ each configuration in parameters.configurations }}:
        - ${{ each policy in configuration.policies }}:
          - job: build_${{ configuration.name }}_${{ replace(policy, '-', '_') }}
            displayName: Build ${{ configuration.name }} ${{ policy }}

            ${{ if eq(configuration.name, 'windows') }}:
              pool:
                name: Default
                demands:
                  - AZP_AGENT_WINDOWS
                  - AZP_AGENT_DOCKER

            ${{ if eq(configuration.name, 'linux') }}:
              pool:
                vmImage: ubuntu-16.04

            workspace:
              clean: all

            steps:
              - checkout: self
                submodules: recursive

              - script: |
                  docker --version
                  docker-compose --version

                  docker container ls -a
                  docker image ls -a
                displayName: Initialize Docker

              - script: |
                  docker-compose run chef-policy-build-${{ configuration.name }} ${{ policy }}
                displayName: Build

              - publish: $(Build.SourcesDirectory)/artifacts/
                artifact: build-${{ configuration.name }}-${{ policy }}
                displayName: Publish Artifacts

              - script: |
                  docker-compose down --rmi local --volumes
                displayName: Clean
                condition: always()

  - stage: acceptance
    displayName: Acceptance

    jobs:
      - ${{ each configuration in parameters.configurations }}:
        - ${{ each policy in configuration.policies }}:
          - job: test_${{ configuration.name }}_${{ replace(policy, '-', '_') }}
            displayName: Test ${{ configuration.name }} ${{ policy }}

            ${{ if eq(configuration.name, 'windows') }}:
              pool:
                name: Default
                demands:
                  - AZP_AGENT_WINDOWS
                  - AZP_AGENT_DOCKER

            ${{ if eq(configuration.name, 'linux') }}:
              pool:
                vmImage: ubuntu-16.04

            workspace:
              clean: all

            steps:
              - checkout: self
                submodules: recursive

              - task: DownloadPipelineArtifact@2
                inputs:
                  artifact: build-${{ configuration.name }}-${{ policy }}
                  path: $(Build.SourcesDirectory)/artifacts/
                displayName: Download Artifacts

              - script: |
                  docker --version
                  docker-compose --version

                  docker container ls -a
                  docker image ls -a
                displayName: Initialize Docker

              - script: |
                  docker-compose run chef-policy-run-${{ configuration.name }} ${{ policy }}
                displayName: Test

              - script: |
                  docker-compose down --rmi local --volumes
                displayName: Clean
                condition: always()
