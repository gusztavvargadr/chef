parameters:
  options: []
    # - directory: directory-name
    #   policy: policy-name

stages:
  - stage: commit
    displayName: Commit

    jobs:
      - ${{ each option in parameters.options }}:
        - job: build_${{ option.directory }}_${{ option.policy }}
          displayName: Build ${{ option.directory }} ${{ option.policy }}

          pool:
            vmImage: ubuntu-16.04

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

            - script: |
                docker version
                docker-compose version
              displayName: Docker Init

            - script: |
                docker-compose build chef
                docker-compose build chef-client-linux
              displayName: Docker Restore

            - script: |
                docker-compose build --build-arg directory=${{ option.directory }} --build-arg policy=${{ option.policy }} chef-policy
              displayName: Docker Build

            - script: |
                docker-compose run chef-policy
              displayName: Docker Package

            - script: |
                docker-compose down --rmi all
              displayName: Docker Clean
              condition: always()

            - publish: $(Build.SourcesDirectory)/.chef/
              artifact: build-${{ option.directory }}-${{ option.policy }}-chef
              displayName: Artifacts Chef Publish
              condition: always()
