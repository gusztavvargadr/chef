parameters:
  options: []
    # - policy: policy-name
    #   directory: folder-name

stages:
  - stage: acceptance
    displayName: Acceptance

    jobs:
      - ${{ each option in parameters.options }}:
        - job: test_${{ option.directory }}_${{ option.policy }}
          displayName: Test ${{ option.directory }} ${{ option.policy }}

          pool:
            vmImage: windows-2019

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

            - script: |
                docker version
                docker-compose version
              displayName: Init

            - download: current
              artifact: policy_${{ option.directory }}_${{ option.policy }}
              displayName: Download

            - task: CopyFiles@2
                inputs:
                  sourceFolder: $(Pipeline.Workspace)/policy_${{ option.directory }}_${{ option.policy }}
                  contents: **
                  targetFolder: .chef/
              displayName: Copy

            - task: DeleteFiles@1
                inputs:
                  sourceFolder: $(Pipeline.Workspace)/policy_${{ option.directory }}_${{ option.policy }}
                  contents: **
                  removeSourceFolder: true
              displayName: Delete

            - script: |
                dir .chef/ /s
              displayName: Review

            - script: |
                docker-compose build --build-arg policy=${{ option.policy }} --build-arg directory=${{ option.directory }} policy_deploy
              displayName: Restore

            - script: |
                docker-compose run policy_deploy
              displayName: Test

            - script: |
                docker-compose down
              displayName: Clean
              condition: always()
